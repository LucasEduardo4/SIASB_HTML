<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consulta Pessoas</title>
    <link rel="stylesheet" href="../../sidebars/bootstrap.min.css">
    <link rel="icon" href="../../icons/warning.png" sizes="192x192"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <link rel="stylesheet" href="../lib/stylesheet.css">
    <script src='./../../flowSite/verificaSessao.js'></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script> <!-- //para o popup -->

    <style>
        .swal-columns {
            display: flex;
            flex-direction: column;
        }
        .swal-columns input {
            margin: 20px 0px;
        }
    </style>


</head>
<header>
    <div>
        <a href="../index.html">

        <h1><i class="bi-arrow-left-circle bi-lg ">Voltar</i></h1></a>
        
    </div>
</header>
<body onload="init()">

    <div class="d-flex align-items-start">
        <div id="esq" class="flex-fill">
          <h3>Pessoas:</h3>
          <p>Filtros:</p>
        </div>
        <div id="dir" class="flex-fill">
        <p></p>
          <button class="btn btn-primary" onclick="window.location.href='../../Cadastro.html'">Adicionar pessoa</button>
        </div>
      </div>
      
    
    <div class="box-sqr">
        <table id="tablePerson" class="table table-striped table-hover">
            <tr class="table table-dark ">
                <th>IDPessoa</th>
                <th>Nome</th>
                <th>CPF</th>
                <th>Matrícula</th>
                <th>Setor</th>
                <th>Secao</th>
                <th>E-mail</th>
                <th>Gestor</th>
                <th>Usuário</th>
            </tr>
        </table>
    </div>
    <div id="tempElement" style="display: none;"></div>
<script>
    function init() {
        displayPersons();
    }

    function displayPersons(){
        var xhr = new XMLHttpRequest();
        xhr.open("POST", "php/consultas.php", true)
        xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
        xhr.onreadystatechange = function(){
            if (xhr.readyState === 4) {
                if (xhr.status === 200) {
                    tablePerson.innerHTML += xhr.responseText;
                } else {
                    tablePerson.innerHTML += "Falha ao carregar as pessoas";
                }
            }
        };
        xhr.send("select_ready_person=" + encodeURIComponent(1));

    }

    function setupEditButtons() {
            var sqrchk = document.getElementsByClassName("bi bi-check-square");
            var sqr = document.getElementsByClassName("bi bi-square");

            for (var i = 0; i < editButtons.length; i++) {
                (function(id) {

                    var removeButton = removeButtons[i];
                    removeButton.addEventListener("click", function() {
                        var element = document.querySelector("#tableStatus tr:nth-child(" + (id + 1) + ")");
                        var ref = element.cells[0].innerText;
                        removeValue(ref);
                    });
                })(i);
            }
    }

    function onoffGerente(ID){
        console.log("entrou")
        var verifica = document.getElementById(`sqr-${ID}`)
        if(verifica.dataset.value == 0){
            verifica = 'desmarcado';
        }else if(verifica.dataset.value == 1){
            verifica = 'marcado';
        }

        var xhr = new XMLHttpRequest();
        xhr.open("POST", "php/consultas.php", true)
        xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
        xhr.onreadystatechange = function(){
            if (xhr.readyState === 4) {
                if (xhr.status === 200) {
                    window.location.reload();
                } else {
                    console.error("Falha ao carregar as pessoas");
                }
            }
        };
        xhr.send("verifica=" + encodeURIComponent(verifica)+ "&id=" + ID);
    }
 
    function verificaUsuario(usuario){
        var usuarioID = usuario.id
        var pai = usuario.parentElement;
        var pai_do_pai = pai.parentElement;
        var nome = pai_do_pai.querySelector("#nomeCompleto");
        var CPF = pai_do_pai.querySelector("#CPF");
        var data={
            nome: nome.textContent,
            CPF: CPF.textContent
        };
        abrirPopup(usuarioID, pai, data);
    }

    function abrirPopup(usuarioID, pai, data) {
        Swal.fire({
            title: 'Escolha uma opção, para alterar o tipo de usuário',
            html: `
            <div class="swal-columns">
                <label>
                <input type="radio" name="opcao" id="opcao1" value="opcao1">
                Usuário Comum
                </label>
                <label>
                <input type="radio" name="opcao" id="opcao2" value="opcao2">
                Administrador
                </label>
                <label id='naocadastrado'>
                <input type="radio" name="opcao" id="opcao3" value="opcao3">
                Não Cadastrado
                </label>
            </div>
            `,
            inputValidator: (result) => {
            if (!result) {
                return 'Você precisa selecionar uma opção!';
            }
            },
            showCancelButton: true,
            cancelButtonText: 'Cancelar',
            confirmButtonText: 'Confirmar',
            preConfirm: () => {
                const selectedOption = document.querySelector('input[name="opcao"]:checked').value;
                if (selectedOption === 'opcao1') { // Ação para Usuario comum
                    if(usuarioID == 'usuarioNaoCadastrado')
                        CadastroUsuario('', pai.id, data);
                    else if(usuarioID == 'usuarioAdministrador'){
                        console.log('retirar privilegio')
                        alterarPrivilegioUsuario('retirar', pai.id);
                    }else if(usuarioID == 'usuarioDesabilitado'){
                        // console.log('habilitar usuario')
                        alterarStatusUsuario('habilitar', pai.id);
                        alterarPrivilegioUsuario('retirar', pai.id);
                    }else
                    if(usuarioID == 'usuarioComum')
                        mesmoTipoUsuario();
                } else 
                if (selectedOption === 'opcao2') {// Ação para Administrador
                    if(usuarioID == 'usuarioNaoCadastrado'){
                        CadastroUsuario(1, pai.id, data);
                    }else 
                    if(usuarioID == 'usuarioComum'){
                        alterarPrivilegioUsuario('adicionar', pai.id);
                    }else
                    if(usuarioID == "usuarioDesabilitado"){
                        // console.log('habilitar usuario')
                        alterarStatusUsuario('habilitar', pai.id);
                        alterarPrivilegioUsuario('adicionar', pai.id);
                    }else

                    if(usuarioID == 'usuarioAdministrador')
                        mesmoTipoUsuario();
                } else
                if(selectedOption === 'opcao4'){ //Ação para desabilitar usuario
                    console.log('selecionou desabilitar usuario');
                    alterarStatusUsuario('desabilitar', pai.id);
                }
            }
        });
        var opcao1 = document.getElementById('opcao1');
        var opcao2 = document.getElementById('opcao2');
        var opcao3 = document.getElementById('opcao3');
        var label = document.getElementById('naocadastrado')

        if (usuarioID == 'usuarioComum') {
            opcao1.checked = true;
            opcao1.disabled = true;
            label.innerHTML= '<input type="radio" name="opcao" id="opcao4" value="opcao4"> Desabilitar Usuário';
        } else if (usuarioID == 'usuarioAdministrador') {
            opcao2.checked = true;
            opcao2.disabled = true;
            label.innerHTML= '<input type="radio" name="opcao" id="opcao4" value="opcao4"> Desabilitar Usuário';
        } else if (usuarioID == 'usuarioNaoCadastrado') {
            opcao3.checked = true;
            opcao3.disabled = true;
            label.innerHTML= '';
        }else if(usuarioID == 'usuarioDesabilitado'){
            label.innerHTML= '';
          
        }
        }

    function alterarPrivilegioUsuario(privilegio, ID_User){
        if(privilegio === 'adicionar'){
            var data = "adicionarPrivilegio=" +1 + "&ID_User=" + encodeURIComponent(ID_User);
            // console.log(data);
            connection(data, "update", "POST")
        }
        else if(privilegio === 'retirar'){
            var data = "retirarPrivilegio=" +1 + "&ID_User=" + encodeURIComponent(ID_User);
            // console.log(data);
            connection(data, "update", "POST")
        }
    }

    function alterarStatusUsuario(status, ID_User){
        if(status === 'desabilitar'){
            var data = "desabilitarUsuario=" +1 + "&ID_User=" + encodeURIComponent(ID_User);
            // console.log(data);
            connection(data, "update", "POST")
        }
        else if(status === 'habilitar'){
            var data = "habilitarUsuario=" +1 + "&ID_User=" + encodeURIComponent(ID_User);
            connection(data, "update", "POST")
        }
    }

    function CadastroUsuario(adm, ID_User, data){ 
        console.log(data.nome);
        console.log(data.CPF);
                    
        var nomeUsuario = criaNomeUsuario(data.nome);

        data = "registerUser=" + encodeURIComponent(1) + "&nome=" + encodeURIComponent(nomeUsuario) + "&senha=" + encodeURIComponent(data.CPF)+ "&idUsuario=" + encodeURIComponent(ID_User) + "&adm=" + encodeURIComponent(adm);
            connection(data, "update", "POST");
            Swal.close();
            showAlert();


        function criaNomeUsuario(username) {
            username = username.toLowerCase();

            // Separar o primeiro e o último nome
            var nomes = username.split(' ');
            var primeiroNome = nomes[0];
            var ultimoNome = nomes[nomes.length - 1];

            // Unir o primeiro e o último nome com '_'
            var nomeCompleto = primeiroNome + '_' + ultimoNome;

            return nomeCompleto;
        } 
    }
    
    function verificaNomeUsuario(){
        var foo = document.getElementById("nome");
        var data = "selectNameUser=" + 1+ "&nome=" + encodeURIComponent(foo.value);
        connection(data, userAllowed, 'POST');
    }

    function connection(data, output, method) {
        console.log(data);
        var xhr = new XMLHttpRequest();
        var url = "php/consultas.php";

        if (method === "GET") {
            url += "?" + data;
        }

        xhr.open(method, url, true);
        xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
        xhr.onreadystatechange = function() {
            if (xhr.readyState === 4) {
                if (xhr.status === 200) {
                    if(output == "update"){
                        window.location.reload();
                    }else
                    output.innerHTML = xhr.responseText;
                    // return xhr.responseText;
                    // console.log(xhr.responseText);
                } else {
                    output.innerHTML = "Falha ao conectar ao banco de dados";
                }
            }
        };

        if (method === "POST") {
            xhr.send(data);
        } else {
            xhr.send();
        }
    }

    function mesmoTipoUsuario(){
        Swal.fire({
            title: 'Usuário já está cadastrado com essa opção',
            icon: 'warning',
            showConfirmButton: false,
            timer: 2000
        });
    }

    function showAlert() {
        var userAllowed = document.getElementById("userAllowed");
        
        // Salvar o estilo original
        var originalStyle = userAllowed.style.cssText;
        
        // Modificar o estilo para exibir a mensagem de erro
        userAllowed.style.backgroundColor = "red";
        userAllowed.style.color = "white";
        userAllowed.style.display= "block";
        
        // Aguardar 3 segundos
        setTimeout(function() {
            // Restaurar o estilo original
            userAllowed.style.cssText = originalStyle;
            
            // Limpar a mensagem de erro
            userAllowed.textContent = "";
        }, 3000);
    }

</script>
</body>
</html>