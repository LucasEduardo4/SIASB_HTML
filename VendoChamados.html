<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>Filtro de Chamados</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <!-- <link rel="stylesheet" href="sidebars/bootstrap.min.css"> -->
    <script src="/siasb_html/flowSite/verificaSessao.js"></script>

    <style>
        /* Estilos para o formulário */

        .top-div {
            display: flex;
            /* flex-direction: column; */
            align-items: center; 
            justify-content: space-between;       
            margin: 30px auto;    
        }
        .row{
            display: flex;
            align-items: center;
            justify-content: space-between;       

        }
        #myIframe {
            width: 100%;
        }

        .logo {
            position: absolute;
            width: 40px;
            height: 40px;
            left: 40px;
            margin: 0 auto;
            background-color: #eee;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2;
            top: 30px;
        }

        .logo img {
            max-width: 100%;
            max-height: 100%;
            border-radius: 6px;
        }

        .container {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 40px;
            /* max-width: 30%; */
            width: 200px;
            height: 70px;
            background-color: white;
            margin-top: 50px;
            margin-bottom: 50px;
            border-radius: 5px;
            box-shadow: 0px 2px 4px rgba(0, 0, 0, 0.5)

        }

        form {
            max-width: 100%;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
            border-radius: 5px;
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            font-family: 'Lucida Sans', 'Lucida Sans Regular', 'Lucida Grande', 'Lucida Sans Unicode', Geneva, Verdana, sans-serif;
        }

        h2 {
            width: 100%;
            text-align: center;
            font-family: 'Gill Sans', 'Gill Sans MT', 'Calibri', 'Trebuchet MS', sans-serif;
            color: #004235b6;


        }

        .form-group {
            flex-basis: 45%;
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #004235b6;
        }

        input[type="text"],
        select {
            width: 80px;
            padding: 10px;
            padding-left: 10px;
            padding-right: 30px;
            border-radius: 3px;
            border: 1px solid #ccc;
        }

        button {
            width: 100%;
            padding: 10px;
            background-color: #004235b6;
            color: #fff;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            margin: auto;
        }

        .resultados {
            display: flex;
            margin-top: 20px;
            background-color: #ffffff;
            color: black;
            padding: 10px;
            border-radius: 5px;
        }

        .MeusCampos {
            padding-left: 0px;
            margin-right: 30px;
            padding-top: 10px;
        }

        .FaixaForm {
            background-color: #004235b6;
            border-radius: 3px;
            display: flex;
            margin-bottom: 10px;
        }

        .FaixaFormResults {
            background-color: white;
            color: black;
            border-radius: 3px;
            margin-bottom: 5px;
            height: 40px;
            border-bottom: solid 1px grey;
            display: flex;
            align-items: center;
            justify-content: center;

            /* margin-top: 20px; */
        }

        /* VOU UTILIZAR PARA A PARTE DE CIMA E PARA PARTE DE BAIXO */
        .CamposResultados {
            width: 100%;
            display: flex;
            color: white;
            text-align: center;
            align-items: center;
            justify-content: center;
        }

        .cells {
            display: inline-block;
            color: black;
            width: 100%;
            display: flex;
            align-items: center;
            /* height: 100vh; */
            text-align: center;
            justify-content: center;



        }

        #temp {
            padding: 1px 20px;
            background-color: #004235b6;
            color: white;
            border-radius: 6px;
        }

        select {
            padding-left: 2px;
            width: fit-content;
        }

        .datas {
            width: 100px;
        }

        a {
            text-decoration: none;
        }

        .cells p {
            padding-top: 2px;
            /* margin-top: 2px; */
            margin: 0px;
            /* height: 100%; */
            display: inline-block;
            vertical-align: middle;
        }
        #sendButton{
            width: 70%;
            margin: auto;
        }

        /* Css para as cores, baseando no status */
        .statusColors {
            width: 80px;
            padding: 4px;
            color: white;
            border-radius: 3px;
            text-align: center;
            text-shadow: 0px 0px 2px black;
        }

        .Aberto {
            background-color: #e74c3c;
        }

        .Andamento {
            background-color: #7241dcf6;
        }

        .Pendente {
            background-color: #e67e22;
        }

        .Fechado {
            background-color: #2ecc71;
        }

        .disabled {
            background-color: #e9ecef;
        }

        .CamposResultados p {
            cursor: pointer;
        }
       
    </style>
</head>

<body onload="init()">
    <div class="container">
        <div style="border-radius: 5px;" class="div-superior">
            <div style="border-radius: 10px;" class="logo">
                <img src="..\SIASB_HTML\Icones Site\TELEFONE.png">
            </div>
            <h2 style="color: #004235b6; font-size: 21px;">ABRIR CHAMADO</h2>
            <button onclick="window.location.href = 'AbrindoChamado.html'">
                Novo Chamado
            </button>
            <!-- Conteúdo adicional da div superior -->
        </div>
    </div>
    <!-- <div class="container">

        <div class="container">

            <a href="FiltroChamados.html" id="temp">
                <p>Filtro Chamados</p>
            </a>
        </div>
        <div class="container">

            <a href="DetalhandoChamado.html" id="temp">
                <p>Detalhando chamado</p>
            </a>
        </div>
    </div> -->

<<<<<<< HEAD
    <form style="background-color: rgba(255, 255, 255, 0.322); border-radius: 5px; box-shadow: 0px 2px 4px rgba(0, 0, 0, 0.5);margin-bottom:100px" id="filtroForm">
        <h2>FILTRO DE CHAMADOS</h2>
=======
    <form style="background-color: white; border-radius: 5px;" id="filtroForm">
        <h2>FILTROS DE CHAMADOS</h2>
>>>>>>> c5c914326ffb1be2de42950d3ae8ad8749f14bf0

        <div class="top-div">
            <div class="row">
                <div class="MeusCampos">
                    <label for="codigoSolicitacao">Código:</label>
                    <input type="text" id="codigoSolicitacao" style="width: 40px;">
                </div>
                
                <div class="MeusCampos">
                    <label for="selectAutores">Autor</label>
                    <select name="selectAutores" id="selectAutores">
                        <option value="" selected hidden>Escolha Abaixo:</option>
                        <option value="">Nenhum</option>
                    </select>
                </div>
                <div class="MeusCampos">
                    <label for="selectResponsavel">Responsavel</label>
                    <select name="selectResponsavel" id="selectResponsavel">
                        <option value="" selected hidden>Escolha Abaixo:</option>
                        <option value="">Nenhum</option>
                    </select>
                </div>
                <div class="MeusCampos">
                    <label for="stiID">Equipamento</label>
                    <input type="text" id="stiID" onkeyup="verificaTamanho(this,4,'sendButton')"
                       placeholder="STI-ID" onblur="verificaEquipamento()" style="width: 40px;" name="sti_ID" id="sti_ID">
                </div>
                <div style="margin-top: 25px " class="MeusCampos">
                    <input type="text" id="equipamentoNome" disabled style="width: 120px;">
                </div>
            </div>
            <div class="row">
                <div class=" MeusCampos">
                    <label for="data">Data: </label>
                    <select class="form-select" name="data" id="data" onchange="ativaIntervalo()">
                        <option value="" selected hidden>Selecione a opção</option>
                        <option value="1">Abertura</option>
                        <option value="2">Fechamento</option>
                    </select>
                </div>
                <div class="MeusCampos datas">
                    <label for="dataDe"> </label> <!-- deixei esse label vazio para nao desalinhar a data -->
                    <input type="date" id="dataDe" class="datas" placeholder="De:" disabled readonly required>
                </div>
                <div class="MeusCampos datas">
                    <label for="dataAte"> </label> <!-- deixei esse label vazio para nao desalinhar a data -->
                    <input type="date" id="dataAte" class="datas" placeholder="Até:" disabled readonly required>

                </div>
                <div class="MeusCampos">
                    <label for="status">Status:</label>
                    <select id="status" name="status">
                        <option value="5" selected hidden>Selecione...</option>
                    </select>
                </div>

                
            </div>
        </div>
        <button type="submit" id="sendButton">Aplicar Filtros</button>
    </form>

    <div class="resultados" id="resultadosContainer" style="display: none;">
        <div class="FaixaForm" style="color: white;">
            <!-- <div class="CamposResultados">
                <p style="padding-left: 10px;"> ID da Solicitação </p>
            </div> -->
            <div class="CamposResultados">
                <p class="sortable" onclick="ordenar('dataAbertura', this)"> Data de Abertura</p>
            </div>
            <div class="CamposResultados">
                <p class="sortable" onclick="ordenar('assunto', this)"> Assunto</p>
            </div>
            <div class="CamposResultados">
                <p class="sortable" onclick="ordenar('autor', this)"> Autor</p>
            </div>
            <div class="CamposResultados">
                <p class="sortable" onclick="ordenar('responsavel', this)"> Responsavel</p>
            </div>
            <div class="CamposResultados">
                <p class="sortable" onclick="ordenar('equipamento', this)"> STI-ID</p>
            </div>
            <div class="CamposResultados">
                <p class="sortable" onclick="ordenar('status_chamado', this)"> Status</p>
            </div>
            <!-- <div class="CamposResultados responsavel_tecnologia"> <p>Andamento</p> </div> -->
        </div>
        <div id="resultados">

            <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

            <script>
                flatpickr("#dataDe", {
                    dateFormat: "d/m/Y"
                });
                flatpickr("#dataAte", {
                    dateFormat: "d/m/Y"
                });
                const filtroForm = document.getElementById('filtroForm');
                const resultadosContainer = document.getElementById('resultadosContainer');
                const resultados = document.getElementById('resultados');
                ativaIntervalo(0);

                function init() {
                    selectChamados();
                    selectPessoas();
                }

                function ordenar(coluna, elemento) {
                    var colunasOrdenaveis = document.querySelectorAll('.sortable');

                    // Remover o ícone de ordem de todas as colunas
                    if (!elemento.innerHTML.includes('▼') && !elemento.innerHTML.includes('▲')) {
                        colunasOrdenaveis.forEach(function (col) {
                            col.innerHTML = col.textContent.replace(' ▼', '').replace(' ▲', '');
                        });
                    }

                    if (elemento.innerHTML.includes('▼')) {
                        elemento.innerHTML = elemento.innerHTML.replace('▼', '▲');
                        // submitForm('desc');
                    } else if (elemento.innerHTML.includes('▲')) {
                        elemento.innerHTML = elemento.innerHTML.replace('▲', '▼');
                    } else
                        elemento.innerHTML = elemento.innerHTML + ' ▼';

                    if (elemento.innerHTML.includes('▼')) {
                        submitForm(coluna, 'desc');
                    } else if (elemento.innerHTML.includes('▲')) {
                        submitForm(coluna, 'asc');
                    }
                }

                function selectPessoas() {
                    var data = "Select=" + 2;
                    xhrRequest(data, 'selectsJSON');
                }

                function verificaTamanho(inputElement, tamanho, proximoCampo) {
                    if (inputElement.value.length > tamanho) {
                        inputElement.value = inputElement.value.slice(0, tamanho);
                    }
                    if (inputElement.value.length === tamanho) {
                        document.getElementById(proximoCampo).focus();
                    }
                }

                function verificaEquipamento() {
                    var stiID = document.getElementById("stiID").value;
                    data = "Select=" + 3 + "&stiID=" + stiID;
                    xhrRequest(data, 'Equipamento');
                }

                function unParse(json) {
                    // console.log(json);
                    var JSONObj = JSON.parse(json);
                    var selectAutores = document.getElementById("selectAutores");
                    var selectResponsavel = document.getElementById("selectResponsavel");
                    var selectStatus = document.getElementById("status");

                    for (var i = 0; i < JSONObj.usuarios.length; i++) {
                        var option = document.createElement("option");
                        option.value = JSONObj.usuarios[i].IDUsuario;
                        option.text = JSONObj.usuarios[i].nome;
                        selectAutores.appendChild(option);
                    }

                    for (var i = 0; i < JSONObj.responsaveis.length; i++) {
                        var option = document.createElement("option");
                        option.value = JSONObj.responsaveis[i].IDUsuario;
                        option.text = JSONObj.responsaveis[i].nome;
                        selectResponsavel.appendChild(option);
                    }

                    for (var i = 0; i < JSONObj.status.length; i++) {
                        var option = document.createElement("option");
                        option.value = JSONObj.status[i].IDStatus;
                        option.text = JSONObj.status[i].descricao;
                        selectStatus.appendChild(option);
                    }


                }

                function ativaIntervalo(param) {
                    var dataDe = document.getElementById("dataDe");
                    var dataAte = document.getElementById("dataAte");
                    if (param == 0) {
                        dataDe.disabled = true;
                        dataAte.disabled = true;
                        dataDe.classList.add("disabled");
                        dataAte.classList.add("disabled");
                    } else {

                        dataDe.disabled = false;
                        dataAte.disabled = false;
                        dataDe.classList.remove("disabled");
                        dataAte.classList.remove("disabled");
                    }
                }

                filtroForm.addEventListener('submit', function (event) {
                    event.preventDefault();
                    submitForm();
                });

                function submitForm(coluna, ordenar) {
                    var selectData = document.getElementById("data");
                    var dataOption = selectData.options[selectData.selectedIndex].value;
                    var dataDe = document.getElementById("dataDe").value;
                    var dataAte = document.getElementById("dataAte").value;
                    const codigoSolicitacao = document.getElementById('codigoSolicitacao').value;
                    const selectAutores = document.getElementById("selectAutores").options[document.getElementById("selectAutores").selectedIndex].value;
                    const selectResponsavel = document.getElementById("selectResponsavel").options[document.getElementById("selectResponsavel").selectedIndex].value;
                    const stiID = document.getElementById('stiID').value;
                    const status = document.getElementById('status').value;

                    var data = "Select=" + 1 +
                        "&dataOption=" + encodeURIComponent(dataOption) +
                        "&dataDe=" + encodeURIComponent(dataDe) +
                        "&dataAte=" + encodeURIComponent(dataAte) +
                        "&codigoSolicitacao=" + encodeURIComponent(codigoSolicitacao) +
                        "&status=" + encodeURIComponent(status) +
                        "&autor=" + encodeURIComponent(selectAutores) +
                        "&responsavel=" + encodeURIComponent(selectResponsavel) +
                        "&stiID=" + encodeURIComponent(stiID);

                    if (ordenar) {
                        data += "&ordenar=" + encodeURIComponent(coluna) +
                            "&ordem=" + encodeURIComponent(ordenar);
                    } else {
                        data += "&ordenar=" + encodeURIComponent('dataAbertura') +
                            "&ordem=" + encodeURIComponent('desc');
                    }
                    xhrRequest(data, resultados);
                }

                function detalharChamado(IDChamado) {
                    pai = IDChamado.parentNode;
                    pai = pai.parentNode;
                    id = pai.querySelector("#IDChamado");
                    id = id.querySelector("p").textContent;

                    window.location.href = 'DetalhandoChamado.html?IDChamado=' + id;
                }

                function selectChamados() {
                    var currentDate = new Date();
                    var day = currentDate.getDate();
                    var month = currentDate.getMonth() + 1; // Os meses começam em zero, então adicionamos 1
                    var year = currentDate.getFullYear();
                    // Formatar para "dd/mm/yyyy"
                    var dataAtual = ('0' + day).slice(-2) + '/' + ('0' + month).slice(-2) + '/' + year;
                    var dataAte = dataAtual;
                    var data = "Select=" + 1 +
                        "&dataOption=" + encodeURIComponent('1') +
                        "&dataDe=" + encodeURIComponent('01/01/2023') +
                        "&dataAte=" + encodeURIComponent(dataAte) +
                        "&codigoSolicitacao=" + encodeURIComponent('') +
                        "&status=" + encodeURIComponent('inicial') +
                        "&autor=" + encodeURIComponent('') +
                        "&responsavel=" + encodeURIComponent('') +
                        "&stiID=" + encodeURIComponent('') +
                        "&ordenar=" + encodeURIComponent('dataAbertura') +
                        "&ordem=" + encodeURIComponent('desc');

                    xhrRequest(data, resultados);
                }

                function xhrRequest(data, output) {
                    var xhr = new XMLHttpRequest();
                    xhr.open("POST", "VendoChamados.php", true);
                    xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
                    xhr.onreadystatechange = function () {
                        if (xhr.readyState === 4 && xhr.status === 200) {
                            if (output.id == 'resultados') {
                                output.innerHTML = xhr.responseText;
                            } else
                                if (output == 'selectsJSON') {
                                    unParse(xhr.responseText);
                                } else
                                    if (output == 'Equipamento') {
                                        var equipamento = document.getElementById("equipamentoNome");
                                        equipamento.value = xhr.responseText;
                                    }
                        }
                    };
                    xhr.send(data);

                    resultadosContainer.style.display = 'block';
                }

            </script>
</body>

</html>