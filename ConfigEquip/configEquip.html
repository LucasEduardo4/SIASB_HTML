<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="https://saaeb.com.br/wp-content/uploads/2019/09/favicon.png" sizes="192x192"/>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" crossorigin="anonymous">

    <style>
        .hidden {
            display: none;
        }
        body{
            width: 95%;
            margin: auto;
        }
        h3{ 
            width: 500px;
        }

    </style>

    <title>Document</title>
</head>
<body onload="init()">
    <h3>Configurar Status Chamado</h3>
    <hr>
    <form style="width: 100px; display: inline;">
        <label for="">Adicionar novo status:</label>
        <input type="text" name="novoStatus" required>
    </form>
    <button onclick="submitForm()">></button><br><br><br>
    <caption>Status Existentes:</caption>
    <table border id="tableStatus" style="text-align: center;">
        <tr>
            <th>ID Status</th>
            <th>Descrição status</th>
            <th>Ações</th>
        </tr>
    </table>
    <div id="resultado"></div>
        <h3>Tela funcionando 100%</h3>
        <p>Mas existem algumas alterações válidas:</p>
        <ul>
            <li>Adicionar uma verificação se quer realmente excluir</li>
        </ul>
    <script>
        function init() {
            loadStatus()
                .then(hideSaveButton)
                .then(setupEditButtons)
                .catch(function(error) {
                    console.error(error);
                });
        }

        function loadStatus() {
            return new Promise(function(resolve, reject) {
                var tableStatus = document.getElementById("tableStatus");

                var xhr = new XMLHttpRequest();
                xhr.open("GET", "configEquip.php", true);
                xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
                xhr.onreadystatechange = function() {
                    if (xhr.readyState === 4) {
                        if (xhr.status === 200) {
                            tableStatus.innerHTML += xhr.responseText;
                            resolve();
                        } else {
                            reject(new Error("Falha ao carregar status."));
                        }
                    }
                };
                xhr.send();
            });
        }

        function hideSaveButton() {
            var saveButtons = document.getElementsByClassName("glyphicon glyphicon-floppy-disk");
            for (var i = 0; i < saveButtons.length; i++) {
                var saveButton = saveButtons[i];
                saveButton.style.display = "none";
            }
        }

        function submitForm() {
            var novoStatus = document.getElementsByName('novoStatus')[0].value;

            var xhr = new XMLHttpRequest();
            xhr.open("POST", "configEquip.php", true);
            xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
            xhr.onreadystatechange = function() {
                if (xhr.readyState === 4 && xhr.status === 200) {
                    setupEditButtons();
                    window.location.reload();
                }
            };
            xhr.send("novoStatus=" + encodeURIComponent(novoStatus));
        }

        function setupEditButtons() {
            var editButtons = document.getElementsByClassName("glyphicon glyphicon-pencil");
            var saveButtons = document.getElementsByClassName("glyphicon glyphicon-floppy-disk");
            var removeButtons = document.getElementsByClassName("glyphicon glyphicon-trash");

            for (var i = 0; i < editButtons.length; i++) {
                (function(id) {
                    var editButton = editButtons[i];
                    editButton.addEventListener("click", function() {
                        var element = document.querySelector("#tableStatus tr:nth-child(" + (id + 1) + ")");
                        var ref = element.cells[0].innerText;
                        openEditInput(ref);
                    });

                    var saveButton = saveButtons[i];
                    saveButton.addEventListener("click", function() {
                        var element = document.querySelector("#tableStatus tr:nth-child(" + (id + 1) + ")");
                        var ref = element.cells[0].innerText;
                        saveEditedValue(ref);
                    });

                    var removeButton = removeButtons[i];
                    removeButton.addEventListener("click", function() {
                        var element = document.querySelector("#tableStatus tr:nth-child(" + (id + 1) + ")");
                        var ref = element.cells[0].innerText;
                        removeValue(ref);
                    });
                })(i);
            }
        }

        function openEditInput(id) {
            if(id == "ID Status"){
                id = 1;
            }
            var cell = document.getElementById("desc-" + id);

            if (cell) {
                var descValue = cell.innerHTML;
                var inputElement = document.createElement("input");
                inputElement.type = "text";
                inputElement.value = descValue;
                inputElement.id = "edit-input-" + id;
                cell.innerHTML = "";
                cell.appendChild(inputElement);
                document.getElementById("edit-btn-" + id).style.display = "none";
                document.getElementById("trash-btn-" + id).style.display = "none";
                document.getElementById("save-btn-" + id).style.display = "inline-block";
            }
        }

        function saveEditedValue(id) {
            if(id == "ID Status"){
                id = 1;
            }
            var editedInput = document.getElementById("edit-input-" + id);
            var editedValue = editedInput.value;

            var xhr = new XMLHttpRequest();
            xhr.open("POST", "configEquip.php", true);
            xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
            xhr.onreadystatechange = function() {
                if (xhr.readyState === 4 && xhr.status === 200) {
                    var response = JSON.parse(xhr.responseText);
                    if (response.success) {
                        var cell = document.getElementById("desc-" + id);
                        cell.innerHTML = editedValue;
                        document.getElementById("edit-btn-" + id).style.display = "inline-block";
                        document.getElementById("trash-btn-" + id).style.display = "inline-block";
                        document.getElementById("save-btn-" + id).style.display = "none";
                    } else {
                        alert("Erro ao atualizar o status: " + response.message);
                    }
                }
            };
            xhr.send("editedValue=" + encodeURIComponent(editedValue) + "&id=" + id);
        }

        function removeValue(id) {
            if(id == "ID Status"){
                id = 1;
            }
            var xhr = new XMLHttpRequest();
            xhr.open("POST", "configEquip.php", true);
            xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
            xhr.onreadystatechange = function() {
                if (xhr.readyState === 4 && xhr.status === 200) {
                    window.location.reload();
                }
            };
            xhr.send("deletedId=" + id);
        }
    </script>
</body>
</html>
