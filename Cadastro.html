<!DOCTYPE html>
<html>
<head>
  <title>Cadastro</title>
  <link rel="stylesheet" href="Inicial.css">
  <link rel="icon" href="https://saaeb.com.br/wp-content/uploads/2019/09/favicon.png" sizes="192x192"/>
  <script src="/siasb_html/flowSite/verificaSessao.js"></script>


  <meta charset="UTF-8">


</head>
<body onload="init()">
  <div class="container">
    <h1>Cadastro</h1>
    <!-- <h2>OBS. tirei o method do form.. preciso adicionar um XMLHttpRequest no script</h2> -->
    <form>
      <div class="form-group">
        <label for="nome">Nome:</label>
        <input type="text" id="nome" name="nome" placeholder="Informe seu nome">
      </div>
      <div class="form-group">
        <label for="cpf">CPF:</label>
        <input type="text" id="cpf" name="cpf" placeholder="Informe seu CPF">
      </div>
      <div class="form-group">
        <label for="matricula">Número de Matrícula:</label>
        <input type="text" id="matricula" name="matricula" placeholder="Informe seu número de matrícula">
      </div>
      <div class="form-group">
        <label for="setor">Setor:</label>
        <select id="setor" name="setor">
          <option value="" disabled selected hidden>Escolha uma das opções</option>
        </select>
      </div>
      <div class="form-group">
        <label for="email">E-mail:</label>
        <input type="text" id="email" name="email" placeholder="Informe seu e-mail">
      </div>
      <div class="form-group">
        <div class="form-check">
          <label class="form-check-label" for="usuario">Vincular como usuário</label>
          <input class="form-check-input form-check-inline" type="checkbox" id="usuario" name="usuario" value="usuario">
        </div>
        
        
      </div> 
    </form>
    <div class="form-group">
      <button onclick="submitForm()">Cadastrar</button>
    </div>
</div>
  </div>
</body>



<script>
  function init(){
    getSelect();
  }
  function getSelect(){
    var setor = document.getElementById("setor");

    data= "select_setor=" + encodeURIComponent(1);

    connection(data, setor);

  }

  function submitForm(){
    let nome = document.getElementById("nome").value;
    let cpf = document.getElementById("cpf").value;
    let matricula = document.getElementById("matricula").value;
    let setor = document.getElementById("setor").value;
    let email = document.getElementById("email").value;
    let usuario = document.getElementById("usuario").checked;
    var nomeSeparado = '';
    if(usuario){
      nomeSeparado = separarNomes(nome);
      console.log(nomeSeparado);

        function separarNomes(username) {
        username = username.toLowerCase();

        // Separar o primeiro e o último nome
        var nomes = username.split(' ');
        var primeiroNome = nomes[0];
        var ultimoNome = nomes[nomes.length - 1];

        // Unir o primeiro e o último nome com '_'
        var nomeCompleto = primeiroNome + '_' + ultimoNome;

        return nomeCompleto;
        } // <<< - voltar aqui
        
      } 
      if(nomeSeparado == ''){
        var data = "insertUser=" + 0 + "&nome=" + encodeURIComponent(nome) + "&cpf=" + encodeURIComponent(cpf) + "&matricula=" + encodeURIComponent(matricula)+ "&setor=" + encodeURIComponent(setor) + "&email=" + encodeURIComponent(email) 
      }else{
        var data = "insertUser=" + 1 + "&nome=" + encodeURIComponent(nome) + "&cpf=" + encodeURIComponent(cpf) + "&matricula=" + encodeURIComponent(matricula)+ "&setor=" + encodeURIComponent(setor) + "&email=" + encodeURIComponent(email) + "&username=" + encodeURIComponent(nomeSeparado);
      }
      // console.log(data);
      connection(data, "reload");
    }
    function connection(data, output){
    var xhr = new XMLHttpRequest();
            xhr.open("POST", "Cadastro.php", true)
            xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
            xhr.onreadystatechange = function(){
                if (xhr.readyState === 4) {
                    if (xhr.status === 200) {
                      if(output == "reload"){
                        console.log("usuario inserido com sucesso");
                        // window.location.reload();
                      }
                      if(output == setor);
                        setor.innerHTML += xhr.responseText;
                    } else {
                        console.error("Falha ao carregar as pessoas");
                    }
                }
            };
            xhr.send(data);

    }
  
</script>
</html>